buildscript{
	repositories{
		jcenter()
		mavenCentral()
	}
	
	dependencies{
		classpath "org.codehaus.groovy.modules.http-builder:http-builder:0.7.2"
	}
}

import org.gradle.api.tasks.TaskAction
import org.gradle.api.DefaultTask
import org.gradle.api.Plugin
import org.gradle.api.Project
import groovy.json.JsonSlurper

class WeatherPlugin implements Plugin<Project>{
	
	void apply( Project project ){
		
		project.tasks.create( "dirPath", Copy).configure{
			
		}
		
		//we can include apply "plugin: 'pluginName'" like this
		//project.plugins.apply( 'pluginName' )
		
		project.tasks.create( "credentials", CredentialsTask )
		
		project.tasks.create('weather', WeatherTask).configure{
			dependsOn<<[ "dirPath", "credentials"]
		}
		
		def cities = project.container(City){ name->
			new City(name)
		}
		
		project.configure( project ){
			extensions.create( "weather", CityExtension, cities )
		}
		
		//accessing another plugin
		//project.task.getByName('pluginName').configure{}
	}
}


apply plugin: WeatherPlugin

class City{
	String name
	String countryCode
	String file
	String json
	
	City(name){
		this.name = name
	}
}

class CityExtension{
	String developer
	String map_json
	String map_id
	String cities_dir
	
	final NamedDomainObjectContainer<City> cities
	
	CityExtension( NamedDomainObjectContainer<City> cities ){
		this.cities = cities;
	}
	
	def cities( Closure closure ){
		cities.configure( closure )
	}
}

weather{
	developer = "Juan Mendez"
	cities_dir = "${project.projectDir}/src/main/resources/cities"
	map_json = "${project.projectDir}/src/main/resources/credentials/map.json"
	
	cities{
		"Tehran" {
			countryCode ="IR"
			file = "tehran.json"
		}
		
		"Guatemala City" {
			countryCode= "GT"
			file = "guatemala.json"
		}
		
		"Chicago" {
			countryCode= "us"
			file = "chicago.json"
		}
		
		"Havana" {
			countryCode ="CU"
			file = "havana.json"
		}
		
		"San Salvador" {
			countryCode = "SV"
			file = "sansalvador.json"
		}
		
		"Caracas" {
			countryCode = "VE"
			file = "caracas.json"
		}
	}
}


import groovyx.net.http.HTTPBuilder
import static groovyx.net.http.Method.GET
import static groovyx.net.http.ContentType.JSON


class CredentialsTask extends DefaultTask{
	
	@TaskAction
	def getCredentialsId(){
		
		File readMe = project.file( project.weather.map_json );
		String contents = readMe.getText("UTF-8")
		
		def slurper = new JsonSlurper()
		def credentials = slurper.parseText( contents )
		project.weather.map_id = credentials.id;
	}
}

class WeatherTask extends DefaultTask{
	
	def http
	def cities
	def developer
	
	WeatherTask(){
		this.http = new HTTPBuilder( 'http://api.openweathermap.org' )
	}
	
	@TaskAction
	def printCitiesWeather(){
		
		println "cities $project.weather.developer wants to know about their weather"
		
		project.file("$project.weather.cities_dir").deleteDir();
		project.weather.cities.each { city ->
			readWeather( city )
		  }
	}
	
	
	def readWeather( City city ){
		
		project.file("$project.weather.cities_dir").mkdirs();
		http.request( GET, JSON ) {
						  uri.path = '/data/2.5/weather'
						  uri.query = [ APPID:project.weather.map_id, q: "$city.name,$city.countryCode", units:"Imperial" ]
						
						  response.success = { resp, json ->
							 city.json = json
							 
							 
							 project.file("$project.weather.cities_dir/$city.file" ).withWriter { writer ->
								 writer.println city.json
							   }
						  }
						}
						
						http.handler.'404' = { resp ->
							println "Access Issue $resp"
						  }
	}
}

task wrapper( type:Wrapper){
	gradleVersion = "3.3"
}